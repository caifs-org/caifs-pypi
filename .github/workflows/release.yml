name: Release

on:
  workflow_dispatch:
    inputs:
      caifs_version:
        description: "caifs version tag (e.g. v0.6.2). Leave empty for latest."
        required: false
      caifs_common_version:
        description: "caifs-common version tag (e.g. v0.5.0). Leave empty for latest."
        required: false

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      tag: ${{ steps.tag.outputs.tag }}
      pkg_ver: ${{ steps.tag.outputs.pkg_ver }}
      caifs_ver: ${{ steps.tag.outputs.caifs_ver }}
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v6

      - name: Set up Python
        run: uv python install

      - name: Install dependencies
        run: uv sync

      - name: Run tests
        run: uv run pytest

      - name: Vendor caifs and caifs-common
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ./scripts/vendor.sh \
            "${{ github.event.inputs.caifs_version }}" \
            "${{ github.event.inputs.caifs_common_version }}"

      - name: Smoke test
        run: |
          uv run caifs --version
          uv run caifs status

      - name: Build wheel and sdist
        run: uv build

      - name: Determine release tag
        id: tag
        run: |
          # Read version from caifslib.sh directly (caifs --version is broken on Ubuntu
          # because sourcing /etc/os-release overwrites the VERSION variable)
          CAIFS_VER=$(grep '^VERSION=' src/caifs/_vendor/lib/caifslib.sh | cut -d= -f2)
          PKG_VER=$(uv run python -c "import caifs; print(caifs.__version__)")
          TAG="v${PKG_VER}+caifs${CAIFS_VER}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "pkg_ver=$PKG_VER" >> "$GITHUB_OUTPUT"
          echo "caifs_ver=$CAIFS_VER" >> "$GITHUB_OUTPUT"

      - name: Upload dist artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2.5.0
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: ${{ steps.tag.outputs.tag }}
          body: |
            Bundles:
            - caifs ${{ steps.tag.outputs.caifs_ver }}
            - caifs-common (see vendored contents)

            Install:
            ```
            uv tool install caifs
            ```
          files: |
            dist/*.whl
            dist/*.tar.gz
          make_latest: true

  publish:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    environment: pypi
    steps:
      - name: Install uv
        uses: astral-sh/setup-uv@v6

      - name: Download dist artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Publish to PyPI
        run: uv publish dist/*
